{"version":3,"sources":["GameLog.ts"],"names":[],"mappings":";;;;AAAA,2DAA2D;AAC3D,kDAAkD;;AAElD,MAAM;AAEN,uCAAkC;AAClC,kDAA6C;AAC7C,qCAAgC;AAI1B,IAAA,kBAAqC,EAAnC,oBAAO,EAAE,sBAAQ,CAAmB;AAG5C;IADA;QAEI,SAAS;QACD,QAAG,GAAW,0FAA0F,CAAC;QAEjH,YAAY;QACJ,gBAAW,GAAW,OAAO,CAAC;QAEtC,YAAY;QACJ,gBAAW,GAAW,OAAO,CAAC;QAEtC,aAAa;QACL,eAAU,GAAkB,EAAE,CAAC;QAEvC,cAAc;QACN,cAAS,GAAW,CAAC,CAAC;QAE9B,WAAW;QACH,OAAE,GAAW,CAAC,CAAC;QAEvB,aAAa;QACL,cAAS,GAAW,EAAE,CAAC;IAoMnC,CAAC;IAjMG;;;;;;;OAOG;IACU,mCAAiB,GAA9B,UAA+B,KAAa,EAAE,KAAa,EAAE,WAAmB,EAAE,YAAoB,EAAE,UAAkB;;;;gBAClH,MAAM,GAAG,kBAAQ,CAAC,QAAQ,CAAC,MAAM,CAAC;gBAClC,GAAG,GAAG,IAAI,CAAC,GAAG,CAAC;gBACf,QAAQ,GAAG;oBACX,GAAG,EAAE,gBAAgB;oBACrB,WAAW,EAAE,MAAM;oBACnB,WAAW,EAAE,IAAI,CAAC,WAAW;oBAC7B,WAAW,EAAE,kBAAQ,CAAC,QAAQ,CAAC,OAAO;oBACtC,cAAc,EAAE,kBAAQ,CAAC,QAAQ,CAAC,UAAU;oBAC5C,QAAQ,EAAE,kBAAQ,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC,OAAO;oBACnD,WAAW,EAAE,IAAI,CAAC,WAAW;oBAC7B,IAAI,EAAE,aAAa;oBACnB,OAAO,EAAE,kBAAQ,CAAC,QAAQ,CAAC,SAAS;oBACpC,KAAK,OAAA;oBACL,KAAK,OAAA;oBACL,WAAW,aAAA;oBACX,YAAY,cAAA;oBACZ,UAAU,YAAA;iBACb,CAAC;gBACF,IAAI;oBACA,EAAE,CAAC,OAAO,CAAC,EAAE,GAAG,KAAA,EAAE,IAAI,EAAE,QAAQ,EAAE,MAAM,EAAE,KAAK,EAAE,CAAC,CAAC;iBACtD;gBAAC,OAAO,GAAG,EAAE;iBAEb;;;;KACJ;IAED;;OAEG;IACI,+BAAa,GAApB;QACI,IAAI,MAAM,GAAG,kBAAQ,CAAC,QAAQ,CAAC,MAAM,CAAC;QACtC,IAAI,GAAG,GAAG,IAAI,CAAC,GAAG,CAAC;QACnB,IAAI,QAAQ,GAAG;YACX,GAAG,EAAE,gBAAgB;YACrB,WAAW,EAAE,MAAM;YACnB,IAAI,EAAE,aAAa;YACnB,IAAI,EAAE,iBAAO,CAAC,QAAQ,CAAC,KAAK;YAC5B,OAAO,EAAE,kBAAQ,CAAC,QAAQ,CAAC,SAAS;SACvC,CAAC;QACF,IAAI;YACA,EAAE,CAAC,OAAO,CAAC,EAAE,GAAG,KAAA,EAAE,IAAI,EAAE,QAAQ,EAAE,MAAM,EAAE,KAAK,EAAE,CAAC,CAAC;SACtD;QAAC,OAAO,GAAG,EAAE;SAEb;IACL,CAAC;IAED;;OAEG;IACI,+BAAa,GAApB;QACI,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;QAC5B,IAAI,CAAC,EAAE,GAAG,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,MAAM,EAAE,GAAG,MAAM,CAAC,CAAC;QAC7C,IAAI,CAAC,UAAU,GAAG,EAAE,CAAC;IACzB,CAAC;IAED;;;;;;OAMG;IACI,8BAAY,GAAnB,UAAoB,IAAY,EAAE,GAAgB,EAAE,IAAiB;QAAnC,oBAAA,EAAA,OAAe,CAAC;QAAE,qBAAA,EAAA,QAAgB,CAAC;QACjE,aAAa;QACb,IAAI,IAAI,GAAG,IAAI,CAAC,KAAK,CAAC,CAAC,IAAI,CAAC,GAAG,EAAE,GAAG,IAAI,CAAC,SAAS,CAAC,GAAG,GAAG,CAAC,CAAC;QAC3D,IAAI,MAAM,GAAG,IAAI,GAAG,IAAI,GAAG,CAAC,GAAG,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,GAAG,CAAC,QAAQ,CAAC,EAAE,CAAC,CAAC,GAAG,CAAC,IAAI,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,QAAQ,CAAC,EAAE,CAAC,CAAC,CAAC;QACvG,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;IACjC,CAAC;IAGD;;;;OAIG;IACI,2BAAS,GAAhB,UAAiB,OAAe,EAAE,KAAa;QAC3C,IAAI,OAAO,EAAE,IAAI,WAAW;YACxB,OAAO;QAEX,WAAW;QACX,IAAI,IAAI,CAAC,SAAS,IAAI,OAAO;YACzB,OAAO;QACX,IAAI,CAAC,SAAS,GAAG,OAAO,CAAC;QAEzB,IAAI,GAAG,GAAG,IAAI,CAAC,GAAG,CAAC;QACnB,IAAI,MAAM,GAAG,kBAAQ,CAAC,QAAQ,CAAC,MAAM,CAAC;QACtC,IAAI,QAAQ,GAAG;YACX,GAAG,EAAE,gBAAgB;YACrB,WAAW,EAAE,IAAI,CAAC,WAAW;YAC7B,WAAW,EAAE,kBAAQ,CAAC,QAAQ,CAAC,OAAO;YACtC,cAAc,EAAE,kBAAQ,CAAC,QAAQ,CAAC,UAAU;YAC5C,QAAQ,EAAE,kBAAQ,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC,OAAO;YACnD,WAAW,EAAE,IAAI,CAAC,WAAW;YAC7B,OAAO,EAAE,kBAAQ,CAAC,QAAQ,CAAC,SAAS;YACpC,WAAW,EAAE,MAAM;YACnB,IAAI,EAAE,OAAO;YACb,OAAO,EAAE,OAAO;YAChB,KAAK,EAAE,KAAK;SACf,CAAC;QACF,IAAI;YACA,EAAE,CAAC,OAAO,CAAC,EAAE,GAAG,KAAA,EAAE,IAAI,EAAE,QAAQ,EAAE,MAAM,EAAE,KAAK,EAAE,CAAC,CAAC;SACtD;QAAC,OAAO,GAAG,EAAE;SAEb;IACL,CAAC;IAED;;;OAGG;IACI,mCAAiB,GAAxB,UAAyB,KAAa;QAClC,IAAI,OAAO,EAAE,IAAI,WAAW;YACxB,OAAO;QAEX,IAAI,GAAG,GAAG,IAAI,CAAC,GAAG,CAAC;QACnB,IAAI,MAAM,GAAG,kBAAQ,CAAC,QAAQ,CAAC,MAAM,CAAC;QACtC,IAAI,QAAQ,GAAG;YACX,GAAG,EAAE,gBAAgB;YACrB,WAAW,EAAE,IAAI,CAAC,WAAW;YAC7B,WAAW,EAAE,kBAAQ,CAAC,QAAQ,CAAC,OAAO;YACtC,cAAc,EAAE,kBAAQ,CAAC,QAAQ,CAAC,UAAU;YAC5C,QAAQ,EAAE,kBAAQ,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC,OAAO;YACnD,WAAW,EAAE,IAAI,CAAC,WAAW;YAC7B,WAAW,EAAE,MAAM;YACnB,OAAO,EAAE,kBAAQ,CAAC,QAAQ,CAAC,SAAS;YACpC,IAAI,EAAE,gBAAgB;YACtB,IAAI,EAAE,KAAK;SACd,CAAC;QACF,IAAI;YACA,EAAE,CAAC,OAAO,CAAC,EAAE,GAAG,KAAA,EAAE,IAAI,EAAE,QAAQ,EAAE,MAAM,EAAE,KAAK,EAAE,CAAC,CAAC;SACtD;QAAC,OAAO,GAAG,EAAE;SAEb;IACL,CAAC;IAED;;OAEG;IACI,4BAAU,GAAjB;QACI,IAAI,kBAAQ,CAAC,YAAY,IAAI,MAAM,EAAE;YACjC,OAAO;SACV;QACD,IAAI,MAAM,GAAG,IAAI,CAAC,UAAU,CAAC,MAAM,CAAC;QACpC,IAAI,OAAO,GAAG,CAAC,CAAC;QAChB,OAAO,IAAI,CAAC,UAAU,CAAC,MAAM,GAAG,CAAC,EAAE;YAC/B,IAAI,GAAG,GAAG,IAAI,CAAC,UAAU,CAAC,MAAM,CAAC,CAAC,EAAE,IAAI,CAAC,CAAC;YAC1C,IAAI,IAAI,GAAG,GAAG,CAAC,IAAI,CAAC,GAAG,CAAC,CAAA;YACxB,IAAI,CAAC,WAAW,CAAC,MAAM,EAAE,OAAO,EAAE,IAAI,CAAC,CAAC;YACxC,OAAO,EAAE,CAAC;SACb;IACL,CAAC;IAED;;;;;OAKG;IACK,6BAAW,GAAnB,UAAoB,MAAc,EAAE,OAAe,EAAE,IAAY;QAC7D,IAAI,OAAO,EAAE,IAAI,WAAW,IAAI,kBAAQ,CAAC,QAAQ,IAAI,SAAS;YAC1D,OAAO;QACX,IAAI,GAAG,GAAG,IAAI,CAAC,GAAG,CAAC;QACnB,IAAI,MAAM,GAAG,kBAAQ,CAAC,QAAQ,CAAC,MAAM,CAAC;QACtC,IAAI,QAAQ,GAAG;YACX,GAAG,EAAE,gBAAgB;YACrB,WAAW,EAAE,IAAI,CAAC,WAAW;YAC7B,WAAW,EAAE,kBAAQ,CAAC,QAAQ,CAAC,OAAO;YACtC,cAAc,EAAE,kBAAQ,CAAC,QAAQ,CAAC,UAAU;YAC5C,QAAQ,EAAE,kBAAQ,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC,OAAO;YACnD,WAAW,EAAE,IAAI,CAAC,WAAW;YAC7B,OAAO,EAAE,kBAAQ,CAAC,QAAQ,CAAC,SAAS;YACpC,WAAW,EAAE,MAAM;YACnB,IAAI,EAAE,QAAQ;YACd,KAAK,EAAE,MAAM;YACb,KAAK,EAAE,kBAAQ,CAAC,QAAQ,CAAC,KAAK;YAC9B,EAAE,EAAE,IAAI,CAAC,EAAE;YACX,OAAO,EAAE,OAAO;YAChB,IAAI,EAAE,IAAI;SACb,CAAC;QACF,IAAI;YACA,EAAE,CAAC,OAAO,CAAC,EAAE,GAAG,KAAA,EAAE,IAAI,EAAE,QAAQ,EAAE,MAAM,EAAE,KAAK,EAAE,CAAC,CAAC;SACtD;QAAC,OAAO,GAAG,EAAE;SAEb;IACL,CAAC;IAvNgB,OAAO;QAD3B,OAAO;OACa,OAAO,CAwN3B;IAAD,cAAC;CAxND,AAwNC,IAAA;kBAxNoB,OAAO","file":"","sourceRoot":"..\\..\\..\\..\\assets\\scripts","sourcesContent":["// Copyright (C) 2019, Flickering Inc. All rights reserved.\r\n// Author: hongchangfu (hongchangfu@flickering.ai)\r\n\r\n//游戏日志\r\n\r\nimport RootNode from \"./RootNode\";\r\nimport GameCtrl from \"./controller/GameCtrl\";\r\nimport MySound from \"./MySound\";\r\n\r\ndeclare const wx: any;\r\n\r\nconst { ccclass, property } = cc._decorator;\r\n\r\n@ccclass\r\nexport default class GameLog {\r\n    /** 网址 */\r\n    private url: string = 'https://log-app-backend.log-global.aliyuncs.com/logstores/log_web/track?APIVersion=0.6.0';\r\n\r\n    /** 小游戏版本 */\r\n    private app_version: string = \"1.1.2\";\r\n\r\n    /** 资源版本号 */\r\n    private res_version: string = \"1.1.3\";\r\n\r\n    /** 记录操作数据 */\r\n    private actionData: Array<string> = [];\r\n\r\n    /** 游戏开始的时间 */\r\n    private startTime: number = 0;\r\n\r\n    /** 随机id */\r\n    private id: number = 0;\r\n\r\n    /** 上一次的错误 */\r\n    private lastError: string = '';\r\n\r\n\r\n    /**\r\n     * 登入日志\r\n     * @param scene 启动小游戏场景\r\n     * @param query  启动小游戏的参数\r\n     * @param shareTicket 群转发\r\n     * @param referrerInfo 来源信息\r\n     * @param systemInfo 系统信息\r\n     */\r\n    public async sendLaunchInfoLog(scene: number, query: string, shareTicket: string, referrerInfo: string, systemInfo: string) {\r\n        let openid = RootNode.instance.openId;\r\n        let url = this.url;\r\n        let formData = {\r\n            app: 'number_monster',\r\n            user_openid: openid,\r\n            app_version: this.app_version,\r\n            cfg_version: RootNode.instance.version,\r\n            cfg_kidversion: RootNode.instance.kidVersion,\r\n            gametype: RootNode.instance.isKid ? \"kid\" : \"adult\",\r\n            res_version: this.res_version,\r\n            type: \"launch_info\",\r\n            release: RootNode.instance.isRelease,\r\n            scene,\r\n            query,\r\n            shareTicket,\r\n            referrerInfo,\r\n            systemInfo\r\n        };\r\n        try {\r\n            wx.request({ url, data: formData, method: 'GET' });\r\n        } catch (err) {\r\n\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 白名单日志\r\n     */\r\n    public sendWhiteList() {\r\n        let openid = RootNode.instance.openId;\r\n        let url = this.url;\r\n        let formData = {\r\n            app: 'number_monster',\r\n            user_openid: openid,\r\n            type: \"launch_info\",\r\n            mute: MySound.instance.isMut,\r\n            release: RootNode.instance.isRelease,\r\n        };\r\n        try {\r\n            wx.request({ url, data: formData, method: 'GET' });\r\n        } catch (err) {\r\n\r\n        }\r\n    }\r\n\r\n    /** \r\n     * 游戏操作开始记录 \r\n     */\r\n    public startRecorder() {\r\n        this.startTime = Date.now();\r\n        this.id = Math.floor(Math.random() * 100000);\r\n        this.actionData = [];\r\n    }\r\n\r\n    /**\r\n     * 保存数据\r\n     * @param type 操作类型 d 掉落 c 合并 s 拆分  creazy_start 疯狂开始 revival 复活\r\n     * creazy_end 疯狂结束 pause 暂停 finish 结束 signOut 退出 skipGuide 退出新手引导 \r\n     * @param num  操作数1\r\n     * @param num1 操作数2\r\n     */\r\n    public recordAction(type: string, num: number = -1, num1: number = -1) {\r\n        //100毫秒为单位的整数\r\n        let time = Math.floor((Date.now() - this.startTime) / 100);\r\n        let action = time + type + (num == -1 ? \"\" : num.toString(16)) + (num1 == -1 ? \"\" : num1.toString(16));\r\n        this.actionData.push(action);\r\n    }\r\n\r\n\r\n    /**\r\n     * 错误上报\r\n     * @param message 错误\r\n     * @param stack 错误调用堆栈\r\n     */\r\n    public sendError(message: string, stack: string) {\r\n        if (typeof wx == \"undefined\")\r\n            return;\r\n\r\n        //相同错误不重复上报\r\n        if (this.lastError == message)\r\n            return;\r\n        this.lastError = message;\r\n\r\n        let url = this.url;\r\n        let openid = RootNode.instance.openId;\r\n        let formData = {\r\n            app: 'number_monster',\r\n            app_version: this.app_version,\r\n            cfg_version: RootNode.instance.version,\r\n            cfg_kidversion: RootNode.instance.kidVersion,\r\n            gametype: RootNode.instance.isKid ? \"kid\" : \"adult\",\r\n            res_version: this.res_version,\r\n            release: RootNode.instance.isRelease,\r\n            user_openid: openid,\r\n            type: \"Error\",\r\n            message: message,\r\n            stack: stack,\r\n        };\r\n        try {\r\n            wx.request({ url, data: formData, method: 'GET' });\r\n        } catch (err) {\r\n\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 内存警告,只有安卓才有\r\n     * @param level 警告等级\r\n     */\r\n    public sendMemoryWarning(level: number) {\r\n        if (typeof wx == \"undefined\")\r\n            return;\r\n\r\n        let url = this.url;\r\n        let openid = RootNode.instance.openId;\r\n        let formData = {\r\n            app: 'number_monster',\r\n            app_version: this.app_version,\r\n            cfg_version: RootNode.instance.version,\r\n            cfg_kidversion: RootNode.instance.kidVersion,\r\n            gametype: RootNode.instance.isKid ? \"kid\" : \"adult\",\r\n            res_version: this.res_version,\r\n            user_openid: openid,\r\n            release: RootNode.instance.isRelease,\r\n            type: \"memory_warning\",\r\n            data: level,\r\n        };\r\n        try {\r\n            wx.request({ url, data: formData, method: 'GET' });\r\n        } catch (err) {\r\n\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 发送操作日志\r\n     */\r\n    public sendAction() {\r\n        if (RootNode.currentScene != \"game\") {\r\n            return;\r\n        }\r\n        let length = this.actionData.length;\r\n        let section = 0;\r\n        while (this.actionData.length > 0) {\r\n            let arr = this.actionData.splice(0, 1800);\r\n            let data = arr.join(\",\")\r\n            this.sendSection(length, section, data);\r\n            section++;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 数据包发送,可能存在数据太长,分多个包发送的情况\r\n     * @param length 总的数据长度\r\n     * @param section 第几个包\r\n     * @param data 数据\r\n     */\r\n    private sendSection(length: number, section: number, data: string) {\r\n        if (typeof wx == \"undefined\" || GameCtrl.instance == undefined)\r\n            return;\r\n        let url = this.url;\r\n        let openid = RootNode.instance.openId;\r\n        let formData = {\r\n            app: 'number_monster',\r\n            app_version: this.app_version,\r\n            cfg_version: RootNode.instance.version,\r\n            cfg_kidversion: RootNode.instance.kidVersion,\r\n            gametype: RootNode.instance.isKid ? \"kid\" : \"adult\",\r\n            res_version: this.res_version,\r\n            release: RootNode.instance.isRelease,\r\n            user_openid: openid,\r\n            type: \"action\",\r\n            steps: length,\r\n            score: GameCtrl.instance.Score,\r\n            id: this.id,\r\n            section: section,\r\n            data: data\r\n        };\r\n        try {\r\n            wx.request({ url, data: formData, method: 'GET' });\r\n        } catch (err) {\r\n\r\n        }\r\n    }\r\n}"]}