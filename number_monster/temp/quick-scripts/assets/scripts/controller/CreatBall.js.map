{"version":3,"sources":["CreatBall.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"..\\..\\..\\..\\..\\assets\\scripts\\controller","sourcesContent":["// Copyright (C) 2019, Flickering Inc. All rights reserved.\r\n// Author: hongchangfu (hongchangfu@flickering.ai)\r\n\r\n//生成球控制类\r\n\r\nimport Ball from \"../view/Ball\";\r\nimport { ColliderType, EyeState, ballDropSpeed, ballScale } from \"../GameConfig\";\r\nimport GameCtrl from \"./GameCtrl\";\r\nimport RandomBallNum from \"../RandomBallNum\";\r\nimport RootNode from \"../RootNode\";\r\n\r\nconst { ccclass, property } = cc._decorator;\r\n\r\n@ccclass\r\nexport default class CreatBall extends cc.Component {\r\n    /** 生成触发疯狂模式的触发分数 */\r\n    public crazyTrigerNum: number = undefined;\r\n\r\n    /** 疯狂触发球触发概率 */\r\n    public crazyTrigerOdds: number = 0.2;\r\n\r\n    /** 疯狂模式触发球 */\r\n    private _crazyTrigerBall: Ball = undefined;\r\n\r\n    /** 生成速度 */\r\n    private _creatSpeed: number = undefined;\r\n\r\n    /** 球的对象池 */\r\n    private ballArr = {};\r\n\r\n    /** 疯狂球对象池 */\r\n    private crazyPool: Array<Ball> = [];\r\n\r\n    /** 控制creat生成 */\r\n    private creatFlag: boolean = false;\r\n\r\n    /** 距离下一次生成球时间 */\r\n    private nextCreatTime: number = 0;\r\n\r\n    //随机生成球\r\n    private randomBallNum: RandomBallNum = undefined;\r\n\r\n    start() {\r\n        this.randomBallNum = new RandomBallNum();\r\n    }\r\n\r\n    /**\r\n     * 按生成速度和生成概率生成球\r\n     */\r\n    update(dt: number) {\r\n        if (!this.creatFlag)\r\n            return;\r\n        this.nextCreatTime -= dt;\r\n        if (this.nextCreatTime <= 0 && this.judgeCreat()) {\r\n            this.randomBall();\r\n            this.nextCreatTime = this._creatSpeed;\r\n        }\r\n    }\r\n\r\n\r\n    /**\r\n     * 游戏开始生成五个球,再按生成速度生成\r\n     */\r\n    public initCreat() {\r\n        let count = 0\r\n        let callback = () => {\r\n            if (GameCtrl.instance.pause == true)\r\n                return;\r\n            if (count == 3) {\r\n                this.creatFlag = true;\r\n                this.unschedule(callback);\r\n            }\r\n            this.randomBall();\r\n            count++;\r\n        }\r\n        this.schedule(callback, 0.15)\r\n    }\r\n\r\n    /**\r\n     * 新手引导球生成\r\n     */\r\n    public guideCreat() {\r\n        let arr = [2, 2, 7, 6, 5, 5];\r\n        let callback = () => {\r\n            if (arr.length == 0) {\r\n                this.unschedule(callback);\r\n                return;\r\n            }\r\n            let num = arr.shift();\r\n\r\n            //记录掉落操作\r\n            RootNode.instance.gameLog.recordAction('d', num);\r\n            this.ballBirth(num);\r\n        }\r\n        this.schedule(callback, 0.1);\r\n    }\r\n\r\n    /**\r\n     * 疯狂模式结束,疯狂球清空\r\n     */\r\n    public crazyPoolClear() {\r\n        let length = this.crazyPool.length;\r\n        for (let i = 0; i < length; i++) {\r\n            this.crazyPool[i].node.parent = undefined;\r\n            this.crazyPool[i].node = undefined;\r\n        }\r\n        this.crazyPool = [];\r\n    }\r\n\r\n    /**\r\n     * 获取触发球\r\n     */\r\n    public get crazyTrigerBall() {\r\n        return this._crazyTrigerBall;\r\n    }\r\n\r\n    /**\r\n     * 停止球的生成\r\n     */\r\n    public stopCreat() {\r\n        this.creatFlag = false;\r\n    }\r\n\r\n    /**\r\n     * 设置球生成速度\r\n     */\r\n    public set creatSpeed(num: number) {\r\n        this._creatSpeed = num;\r\n    }\r\n\r\n    /** \r\n     * 球回收\r\n     */\r\n    public ballRecovery(ball: Ball) {\r\n        if (undefined == ball)\r\n            return;\r\n\r\n        let ballnum = ball.ballNum;\r\n        ball.resume();\r\n\r\n        //触发球不放入对象池\r\n        if (ball == this._crazyTrigerBall) {\r\n            this._crazyTrigerBall.node.removeFromParent();\r\n            this._crazyTrigerBall = undefined;\r\n            return;\r\n        }\r\n\r\n        //疯狂模式下的5\r\n        if (ball.crazyBall) {\r\n            if (ballnum == 5) {\r\n                this.crazyPool.push(ball);\r\n                //去重\r\n                let set = new Set(this.crazyPool);\r\n                this.crazyPool = Array.from(set);\r\n                return;\r\n            }\r\n        }\r\n\r\n        //引导模式下的球不回收,因为触发监听有问题\r\n        if(GameCtrl.instance.guide)\r\n        {\r\n            ball.node.removeFromParent();\r\n            return;\r\n        }\r\n\r\n        //大球不回收\r\n        if (ballnum > 10)\r\n            return;\r\n\r\n        let numstr = ballnum.toString();\r\n        let arr = this.ballArr[numstr];\r\n        if (arr == undefined) {\r\n            arr = new Array<Ball>();\r\n            this.ballArr[numstr] = arr;\r\n        }\r\n\r\n        if (arr.length < 5) {\r\n            arr.push(ball);\r\n        } else {\r\n            ball.node.parent = undefined;\r\n            ball.node = undefined;\r\n        }\r\n\r\n        //去重,修改生成后球消失的bug\r\n        let set = new Set(arr);\r\n        this.ballArr[numstr] = Array.from(set);\r\n    }\r\n\r\n    /**\r\n     * 更新球的生成概率\r\n     * @param oddsStr 概率字符串\r\n     */\r\n    public updateOddsMap(oddsStr: string) {\r\n        this.randomBallNum.updateOddsMap(oddsStr);\r\n    }\r\n\r\n    /**\r\n     * 在具体位置生成球\r\n     * @param num 生成球数字\r\n     * @param pos 生成球位置\r\n     */\r\n    public creatBallForPos(num: number, pos: cc.Vec2): cc.Node {\r\n        let ball = this.getBall(num);\r\n        let node = ball.node;\r\n        node.position = pos;\r\n        return node;\r\n    }\r\n\r\n    /**\r\n     * 暂停\r\n     */\r\n    public set pause(enable: boolean) {\r\n        if (enable) {\r\n            this.creatFlag = false;\r\n        } else\r\n            this.creatFlag = true;\r\n    }\r\n\r\n    /**\r\n     * 判断球生成,主要用于限制,桌面上球的数量\r\n     */\r\n    private judgeCreat(): boolean {\r\n        let ballarr = GameCtrl.instance.getGamePanelBall();\r\n        let num = 0;\r\n        let length = ballarr.length;\r\n        if (length < 18)\r\n            return true;\r\n        for (let i = 0; i < length; i++) {\r\n            //小球体积小当0.5个\r\n            if (ballarr[i].ballNum < 5)\r\n                num += 0.5;\r\n            else\r\n                num++;\r\n        }\r\n        if (num > 18)\r\n            return false;\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * 按概率随机创建球\r\n     */\r\n    private randomBall() {\r\n        let num = this.crazyTrigerNum;\r\n\r\n        //超过触发分数,随机到的数字为5\r\n        if (num != undefined && num < GameCtrl.instance.Score) {\r\n            //概率触发\r\n            if (Math.random() < this.crazyTrigerOdds) {\r\n                this.crazyTrigerOdds = 0.2;\r\n                let ball = this.creatNewBall(16);\r\n                this._crazyTrigerBall = ball;\r\n                this.initCrazyTrigerBall(ball);\r\n                this.crazyTrigerNum = undefined;\r\n                return;\r\n            }\r\n        }\r\n        let ranNum = this.randomBallNum.getBallNum();\r\n        //记录掉落操作\r\n        RootNode.instance.gameLog.recordAction('d', ranNum);\r\n\r\n        this.ballBirth(ranNum);\r\n    }\r\n\r\n    /**\r\n     * 疯狂触发球设置\r\n     */\r\n    private async initCrazyTrigerBall(ball: Ball) {\r\n        let node = ball.node;\r\n        //位置\r\n        node.position = new cc.Vec2(0, 1000);\r\n        let trggerNode = cc.instantiate(GameCtrl.instance.crazyTriggerPrefab);\r\n        trggerNode.parent = node;\r\n\r\n        //按配置缩放到疯狂球相同大小\r\n        trggerNode.scale = ballScale[15];\r\n        //变为普通球特效\r\n        let normal = undefined;\r\n\r\n        //无操作,五秒后消失变普通球\r\n        let action = cc.sequence(\r\n            cc.delayTime(8),\r\n            cc.callFunc(() => {\r\n                normal = cc.instantiate(GameCtrl.instance.crazyToNomalPrefab);\r\n                normal.parent = node;\r\n                normal.scale = ballScale[15];\r\n                normal.position = cc.Vec2.ZERO;\r\n                let callback = ()=>{\r\n                    if (normal != undefined) {\r\n                        normal.removeFromParent();\r\n                    }\r\n                    this.ballRecovery(this._crazyTrigerBall);\r\n                }\r\n                this.scheduleOnce(callback,0.37);\r\n            }),\r\n            cc.delayTime(5 / 30),\r\n            cc.callFunc(() => {\r\n                let newBall = this.creatBallForPos(5, node.position);\r\n                normal.parent = newBall;\r\n                normal.position = cc.Vec2.ZERO;\r\n                //触发球移除屏幕,等时机到自动回收\r\n                node.position = new cc.Vec2(0, 10000);\r\n            }),\r\n        )\r\n        node.runAction(action);\r\n    }\r\n\r\n    /**\r\n     * 球生成设置\r\n     */\r\n    private ballBirth(ballnum: number) {\r\n        let ball = this.getBall(ballnum);\r\n        let width = ball.node.getContentSize().width;\r\n\r\n        //1000为下降高度, x为随机位置\r\n        let x = -360 + width / 2 + Math.random() * (720 - width);\r\n        ball.node.position = new cc.Vec2(x, 1000);\r\n        this.setBirthSpeed(ball);\r\n    }\r\n\r\n    /**\r\n     * 球生成起始速度\r\n     * @param ball 球\r\n     */\r\n    private setBirthSpeed(ball: Ball) {\r\n        let callback = () => {\r\n            let speed = ball.rigid.linearVelocity;\r\n            if (speed.y < 0) {\r\n                ball.speed = new cc.Vec2(0, -ballDropSpeed);\r\n                this.unschedule(callback);\r\n            }\r\n        }\r\n        this.schedule(callback, 0.2);\r\n    }\r\n\r\n    /**\r\n     * 根据数字返回需要的球\r\n     * @param num 需要的球的数字\r\n     */\r\n    private getBall(num: number): Ball {\r\n        let instance = GameCtrl.instance;\r\n        let ball: Ball = undefined;\r\n\r\n        //大于10的大球,不保存内存池\r\n        if (num > 10)\r\n            return this.creatNewBall(num);\r\n\r\n        let numstr = num.toString();\r\n        let arr = this.ballArr[numstr];\r\n        //如果是疯狂模式下的5\r\n        if (instance.crazy && num == 5) {\r\n            arr = this.crazyPool;\r\n            //预制放在15;\r\n            num = 16;\r\n        }\r\n        if (arr != undefined && arr.length > 0) {\r\n            ball = arr.shift();\r\n            let node = ball.node;\r\n            node.active = true;\r\n            ball.node.scale = 1;\r\n            node.setParent(instance.gamePanl);\r\n            ball.collider.tag = ColliderType.Birth;\r\n        }\r\n        else\r\n            ball = this.creatNewBall(num);\r\n        return ball;\r\n    }\r\n\r\n    /**\r\n     * 创建一个新球\r\n     */\r\n    private creatNewBall(num: number) {\r\n        let instance = GameCtrl.instance;\r\n        let node = cc.instantiate(instance.ballPreArr[num - 1]);\r\n        let ball = node.getComponent(Ball);\r\n        ball.setNum(num);\r\n        node.setParent(instance.gamePanl);\r\n        ball.collider.tag = ColliderType.Birth;\r\n        return ball;\r\n    }\r\n}"]}